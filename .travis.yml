language: c
compiler: gcc
os:
  - linux
  - osx
cache: ccache
addons:
  apt:
    packages:
    - binutils-mingw-w64-i686
    - binutils-mingw-w64-x86-64
    - build-essential
    - debhelper
    - devscripts
    - dpkg-dev
    - dvb-apps
    - fakeroot
    - g++
    - gcc-mingw-w64-i686
    - gcc-mingw-w64-x86-64
    - g++-mingw-w64-i686
    - g++-mingw-w64-x86-64
    - lcov
    - liba52-0.7.4-dev
    - libasound2-dev
    - libavcodec-dev
    - libavcodec-extra
    - libavdevice-dev
    - libavformat-dev
    - libavutil-dev
    - libfaad-dev
    - libfreetype6-dev
    - libgl1-mesa-dev
    - libjack-dev
    - libjpeg62-dev
    - libmad0-dev
    - libmozjs185-dev
    - libogg-dev
    - libopenjpeg-dev
    - libpng12-dev
    - libpulse-dev
    - libsdl1.2-dev
    - libssl-dev
    - libswscale-dev
    - libtheora-dev
    - libvorbis-dev
    - libxv-dev
    - libxvidcore-dev
    - linux-sound-base
    - mesa-utils
    - mingw-w64-x86-64-dev
    - pkg-config
    - time
    - x11proto-gl-dev
    - x11proto-video-dev
    - zlib1g-dev
  homebrew:
    packages:
    - gnu-time
    - gnu-sed
    - gnu-tar
    - xz
    - lcov
    - faad2
    - sdl
    - freetype
    - libvorbis
    - theora
    - openjpeg
    - libmad
    - xvid
    - libogg
    - spidermonkey
    - ffmpeg
before_install:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then sudo apt-get -y update -qq ; fi
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then brew update; fi
env:
  - GPAC_CONFIGURE_OPTIONS="--prefix=build/mp4box --enable-debug --static-mp4box" DOINSTALL="make install"
  - GPAC_CONFIGURE_OPTIONS="--enable-debug --static-modules"
  - GPAC_CONFIGURE_OPTIONS="--enable-{debug,static-bin}"
matrix:
  include:
    - os: linux
      before_script:
        - "export DISPLAY=:99.0"
        - "sh -e /etc/init.d/xvfb start"
        - sleep 3 # give xvfb some time to start
        - glxinfo # check glx status
      env: GPAC_CONFIGURE_OPTIONS="--enable-{mem-track,gcov}" DOINSTALL="sudo make install" DOTRAVIS="make travis" AUDIODEV=null
    - os: linux
      env: GPAC_CONFIGURE_OPTIONS="--prefix=build/x86_64-w64-mingw32 --enable-debug --static-mp4box --use-zlib=no --target-os=mingw32 --cross-prefix=i686-w64-mingw32- --extra-ldflags=-Lbuild/x86_64-w64-mingw32/lib" GPAC_CONFIGURE_ECFLAGS="-Ibuild/x86_64-w64-mingw32/include -w -fPIC"
    - os: linux
      env: GPAC_CONFIGURE_OPTIONS="--prefix=build/x86_64-w64-mingw32 --enable-debug --static-mp4box --use-zlib=no --target-os=mingw32 --cross-prefix=x86_64-w64-mingw32- --extra-ldflags=-Lbuild/x86_64-w64-mingw32/lib" GPAC_CONFIGURE_ECFLAGS="-Ibuild/x86_64-w64-mingw32/include -w -fPIC"
    - os: linux
      env: GPAC_CONFIGURE_OPTIONS="--prefix=build/all --enable-debug --disable-all" DOINSTALL="make install"
    - os: linux
      env: GPAC_CONFIGURE_OPTIONS="--enable-debug --use-{js,mad,xvid,ogg,vorbis,theora,openjpeg,a52}=no -disable-avi --disable-{streaming,isoff-frag,isoff-hint,isoff-write,loader-xmt,loader-bt,loader-isoff,scene-encode,mcrypt,od-dump,scene-dump,scene-stats,swf,export,import,m2ps,ogg,qtvr,seng,smgr,x3d,3d,ssl,jack,pulse,odf,isoff,m2ts-mux,dvbx,saf,vobsub,ttxt,od-parse,atsc}"
    - os: osx
      env: GPAC_CONFIGURE_OPTIONS="--enable-mem-track" DOINSTALL="sudo make install" AUDIODEV=null
script:
  - ./configure --extra-cflags=''"$GPAC_CONFIGURE_ECFLAGS"'' $GPAC_CONFIGURE_OPTIONS && make && $DOINSTALL && $DOTRAVIS
after_success:
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then bash <(curl -s https://codecov.io/bash) ; fi

notifications:
  email:
    recipients:
      - travisci@gpac.io